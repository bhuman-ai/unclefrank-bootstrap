<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uncle Frank's Bootstrap Core</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-900 text-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // State management
        const initialState = {
            request: '',
            projectContext: '',
            task: null,
            checkpoints: [],
            executionStatus: {},
            sessionId: null,
            logs: [],
            activeThreads: {} // Track thread IDs for each checkpoint
        };

        function App() {
            const [state, setState] = useState(initialState);
            const [loading, setLoading] = useState(false);
            const [executing, setExecuting] = useState(false);
            const executionInterval = useRef(null);

            const API_URL = '/api/task';
            const EXECUTE_URL = '/api/execute';

            // Add log entry
            const addLog = (message, level = 'info') => {
                setState(prev => ({
                    ...prev,
                    logs: [...prev.logs, {
                        timestamp: new Date().toLocaleTimeString(),
                        message,
                        level
                    }]
                }));
            };

            // Classify request
            const classifyRequest = async () => {
                if (!state.request) {
                    alert('Please enter a request');
                    return;
                }
                setLoading(true);
                addLog('Classifying request...', 'info');
                
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'classify', request: state.request })
                    });
                    
                    const data = await response.json();
                    if (response.ok) {
                        addLog(`Classification: ${data.classification.type} (${(data.classification.confidence * 100).toFixed(0)}%)`, 'success');
                    } else {
                        addLog(data.error || 'Classification failed', 'error');
                    }
                } catch (error) {
                    addLog(error.message, 'error');
                }
                setLoading(false);
            };

            // Decompose task
            const decomposeTask = async () => {
                if (!state.request) {
                    alert('Please enter a request');
                    return;
                }
                setLoading(true);
                addLog('Decomposing task into checkpoints...', 'info');
                
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            action: 'decompose', 
                            request: state.request, 
                            projectContext: state.projectContext 
                        })
                    });
                    
                    const data = await response.json();
                    if (response.ok) {
                        setState(prev => ({
                            ...prev,
                            task: data.task,
                            checkpoints: data.checkpoints,
                            executionStatus: data.checkpoints.reduce((acc, cp) => ({
                                ...acc,
                                [cp.id]: { status: 'pending', logs: [] }
                            }), {})
                        }));
                        addLog(`Task decomposed into ${data.checkpoints.length} checkpoints`, 'success');
                    } else {
                        addLog(data.error || 'Decomposition failed', 'error');
                    }
                } catch (error) {
                    addLog(error.message, 'error');
                }
                setLoading(false);
            };

            // Execute all checkpoints
            const executeAllCheckpoints = async () => {
                if (!state.checkpoints.length) {
                    alert('No checkpoints to execute');
                    return;
                }
                
                setExecuting(true);
                addLog('Starting execution session...', 'info');
                
                // Start execution session
                try {
                    const startResponse = await fetch(EXECUTE_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'start' })
                    });
                    
                    const startData = await startResponse.json();
                    if (!startResponse.ok) throw new Error(startData.error);
                    
                    setState(prev => ({ ...prev, sessionId: startData.sessionId }));
                    addLog(`Session started: ${startData.sessionId}`, 'success');
                    
                    // Execute checkpoints sequentially
                    for (const checkpoint of state.checkpoints) {
                        if (checkpoint.blocking || state.checkpoints.indexOf(checkpoint) === 0) {
                            await executeCheckpoint(checkpoint);
                        }
                    }
                    
                    addLog('All checkpoints executed!', 'success');
                } catch (error) {
                    addLog(`Execution error: ${error.message}`, 'error');
                }
                
                setExecuting(false);
            };

            // Execute single checkpoint
            const executeCheckpoint = async (checkpoint) => {
                addLog(`Executing: ${checkpoint.name}`, 'info');
                
                // Update status to in_progress
                setState(prev => ({
                    ...prev,
                    executionStatus: {
                        ...prev.executionStatus,
                        [checkpoint.id]: { status: 'in_progress', logs: [] }
                    }
                }));
                
                try {
                    // Execute via Terragon
                    const execResponse = await fetch(EXECUTE_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            action: 'execute',
                            checkpoint,
                            projectContext: state.projectContext,
                            sessionId: state.sessionId
                        })
                    });
                    
                    const execData = await execResponse.json();
                    if (!execResponse.ok) throw new Error(execData.error);
                    
                    const threadUrl = `https://www.terragonlabs.com/task/${execData.threadId}`;
                    addLog(`${checkpoint.name}: Created in thread ${execData.threadId}`, 'success');
                    
                    // Update status to show execution was sent to Terragon
                    setState(prev => ({
                        ...prev,
                        executionStatus: {
                            ...prev.executionStatus,
                            [checkpoint.id]: {
                                status: 'sent',
                                threadId: execData.threadId,
                                logs: [{ 
                                    message: `Executing in Terragon thread: ${execData.threadId}`,
                                    url: threadUrl
                                }]
                            }
                        },
                        activeThreads: {
                            ...prev.activeThreads,
                            [checkpoint.id]: execData.threadId
                        }
                    }));
                    
                } catch (error) {
                    setState(prev => ({
                        ...prev,
                        executionStatus: {
                            ...prev.executionStatus,
                            [checkpoint.id]: {
                                status: 'fail',
                                logs: [{ message: error.message }]
                            }
                        }
                    }));
                    addLog(`${checkpoint.name} failed: ${error.message}`, 'error');
                }
            };

            // Checkpoint status badge
            const StatusBadge = ({ status }) => {
                const colors = {
                    pending: 'bg-gray-600',
                    in_progress: 'bg-blue-600',
                    sent: 'bg-purple-600',
                    pass: 'bg-green-600',
                    fail: 'bg-red-600'
                };
                
                return (
                    <span className={`px-2 py-1 text-xs rounded ${colors[status] || 'bg-gray-600'}`}>
                        {status}
                    </span>
                );
            };

            // Chat functions
            const sendChatMessage = async () => {
                if (!state.chatInput.trim() || !state.chatThreadId) return;
                
                const message = state.chatInput;
                setState(prev => ({
                    ...prev,
                    chatMessages: [...prev.chatMessages, { 
                        type: 'user', 
                        text: message, 
                        timestamp: new Date().toLocaleTimeString() 
                    }],
                    chatInput: ''
                }));
                
                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            threadId: state.chatThreadId, 
                            message 
                        })
                    });
                    
                    const data = await response.json();
                    if (data.responses) {
                        data.responses.forEach(resp => {
                            setState(prev => ({
                                ...prev,
                                chatMessages: [...prev.chatMessages, { 
                                    type: 'assistant', 
                                    text: resp.text, 
                                    timestamp: resp.timestamp 
                                }]
                            }));
                        });
                    }
                } catch (error) {
                    addLog(`Chat error: ${error.message}`, 'error');
                }
            };

            const startChatSession = async () => {
                const threadId = `chat-${Date.now()}-${Math.random().toString(36).substring(7)}`;
                setState(prev => ({
                    ...prev,
                    chatThreadId: threadId,
                    chatVisible: true,
                    chatMessages: [{
                        type: 'system',
                        text: 'Chat connected to UncleFrank system. You can create tasks by describing what you want.',
                        timestamp: new Date().toLocaleTimeString()
                    }]
                }));
                addLog(`Chat session started: ${threadId}`, 'success');
            };

            const createTaskFromChat = (message) => {
                setState(prev => ({ ...prev, request: message }));
                addLog('Task request populated from chat', 'info');
            };

            return (
                <div className="container mx-auto px-4 py-8 max-w-6xl">
                    <h1 className="text-4xl font-bold mb-2">ðŸ”¨ Uncle Frank's Bootstrap Core</h1>
                    <p className="text-gray-400 mb-8">No BS Autonomous LLM Development Platform</p>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* Left Panel - Input */}
                        <div>
                            <div className="bg-gray-800 rounded-lg p-6 mb-6">
                                <h2 className="text-2xl font-semibold mb-4">Create New Task</h2>
                                
                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-2">Request</label>
                                    <textarea 
                                        value={state.request}
                                        onChange={(e) => setState(prev => ({ ...prev, request: e.target.value }))}
                                        className="w-full px-3 py-2 bg-gray-700 rounded border border-gray-600 focus:border-blue-500 focus:outline-none"
                                        rows="3"
                                        placeholder="e.g., Add Discord bot integration"
                                    />
                                </div>

                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-2">Project Context (optional)</label>
                                    <textarea 
                                        value={state.projectContext}
                                        onChange={(e) => setState(prev => ({ ...prev, projectContext: e.target.value }))}
                                        className="w-full px-3 py-2 bg-gray-700 rounded border border-gray-600 focus:border-blue-500 focus:outline-none"
                                        rows="3"
                                        placeholder="Paste your Project.md content here..."
                                    />
                                </div>

                                <div className="flex gap-2">
                                    <button 
                                        onClick={classifyRequest}
                                        disabled={loading}
                                        className="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded transition disabled:opacity-50"
                                    >
                                        Classify
                                    </button>
                                    <button 
                                        onClick={decomposeTask}
                                        disabled={loading}
                                        className="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded transition disabled:opacity-50"
                                    >
                                        Decompose Task
                                    </button>
                                    {state.checkpoints.length > 0 && (
                                        <button 
                                            onClick={executeAllCheckpoints}
                                            disabled={executing}
                                            className="px-4 py-2 bg-green-600 hover:bg-green-700 rounded transition disabled:opacity-50"
                                        >
                                            {executing ? 'Executing...' : 'Execute All'}
                                        </button>
                                    )}
                                </div>
                            </div>

                            {/* Task Summary */}
                            {state.task && (
                                <div className="bg-gray-800 rounded-lg p-6">
                                    <h3 className="text-lg font-semibold mb-2">{state.task.name}</h3>
                                    <p className="text-gray-400 mb-2">{state.task.objective}</p>
                                    <p className="text-sm">{state.task.acceptanceCriteria.length} acceptance criteria</p>
                                </div>
                            )}
                        </div>

                        {/* Right Panel - Checkpoints & Logs */}
                        <div>
                            {/* Checkpoints */}
                            {state.checkpoints.length > 0 && (
                                <div className="bg-gray-800 rounded-lg p-6 mb-6">
                                    <h3 className="text-lg font-semibold mb-4">Checkpoints</h3>
                                    <div className="space-y-3">
                                        {state.checkpoints.map((cp, i) => (
                                            <div key={cp.id} className="p-3 bg-gray-700 rounded">
                                                <div className="flex justify-between items-start mb-2">
                                                    <div>
                                                        <p className="font-semibold">{i + 1}. {cp.name}</p>
                                                        <p className="text-sm text-gray-400">{cp.objective}</p>
                                                    </div>
                                                    <StatusBadge status={state.executionStatus[cp.id]?.status || 'pending'} />
                                                </div>
                                                <div className="text-xs mt-2">
                                                    <span className={`text-${cp.blocking ? 'red' : 'green'}-400`}>
                                                        {cp.blocking ? 'Blocking' : 'Non-blocking'}
                                                    </span>
                                                    <span className="text-gray-500 ml-2">â€¢ {cp.passCriteria.length} tests</span>
                                                </div>
                                                {state.executionStatus[cp.id]?.logs?.length > 0 && (
                                                    <div className="mt-2 text-xs">
                                                        {state.executionStatus[cp.id].logs.map((log, idx) => (
                                                            <div key={idx} className="text-gray-300">
                                                                {log.message}
                                                                {log.url && (
                                                                    <a 
                                                                        href={log.url} 
                                                                        target="_blank" 
                                                                        className="text-blue-400 hover:underline ml-2"
                                                                    >
                                                                        Open in Terragon â†’
                                                                    </a>
                                                                )}
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                                
                                                {/* Terragon Chat for this checkpoint */}
                                                {state.activeThreads[cp.id] && (
                                                    <div className="mt-3 border-t border-gray-600 pt-3">
                                                        <div className="flex items-center justify-between mb-2">
                                                            <span className="text-xs font-semibold text-gray-400">Terragon Chat</span>
                                                            <span className="text-xs text-gray-500">Thread: {state.activeThreads[cp.id].substring(0, 8)}...</span>
                                                        </div>
                                                        <div className="bg-gray-900 rounded p-2 h-32 overflow-y-auto text-xs mb-2">
                                                            <div className="text-gray-400">
                                                                <p>â†’ Executing: {cp.name}</p>
                                                                <p className="text-gray-500 mt-1">Check Terragon for live updates...</p>
                                                            </div>
                                                        </div>
                                                        <div className="flex gap-1">
                                                            <input 
                                                                type="text" 
                                                                placeholder="Send message to Terragon..."
                                                                className="flex-1 px-2 py-1 bg-gray-700 rounded text-xs border border-gray-600 focus:border-blue-500 focus:outline-none"
                                                                onKeyPress={(e) => {
                                                                    if (e.key === 'Enter' && e.target.value) {
                                                                        // TODO: Send message to Terragon
                                                                        addLog(`Message to ${cp.name}: ${e.target.value}`, 'info');
                                                                        e.target.value = '';
                                                                    }
                                                                }}
                                                            />
                                                            <button 
                                                                className="px-2 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs transition"
                                                                onClick={() => {
                                                                    window.open(`https://www.terragonlabs.com/task/${state.activeThreads[cp.id]}`, '_blank');
                                                                }}
                                                            >
                                                                View
                                                            </button>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Execution Logs */}
                            <div className="bg-gray-800 rounded-lg p-6">
                                <h3 className="text-lg font-semibold mb-4">Execution Logs</h3>
                                <div className="h-64 overflow-y-auto bg-gray-900 rounded p-3 font-mono text-xs">
                                    {state.logs.map((log, i) => (
                                        <div key={i} className={`mb-1 ${
                                            log.level === 'error' ? 'text-red-400' : 
                                            log.level === 'success' ? 'text-green-400' : 
                                            'text-gray-300'
                                        }`}>
                                            <span className="text-gray-500">[{log.timestamp}]</span> {log.message}
                                        </div>
                                    ))}
                                    {state.logs.length === 0 && (
                                        <div className="text-gray-500">No logs yet...</div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>