<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Workspace - Uncle Frank's Doc-Driven Development</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
            background: #0a0a0a;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 15px 20px;
            border-bottom: 2px solid #7c3aed;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header h1 {
            font-size: 24px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-bar {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .status-indicator {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            background: rgba(124, 58, 237, 0.2);
            border: 1px solid #7c3aed;
        }
        
        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        /* 3/4 Document Editor */
        .document-panel {
            flex: 3;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #333;
        }
        
        .doc-tabs {
            display: flex;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
        }
        
        .doc-tab {
            padding: 10px 20px;
            background: transparent;
            color: #888;
            border: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .doc-tab.active {
            color: #fff;
            background: #0a0a0a;
            border-bottom-color: #7c3aed;
        }
        
        .doc-tab:hover {
            color: #fff;
        }
        
        .document-viewer {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #0a0a0a;
        }
        
        .document-content {
            font-family: 'Monaco', 'Courier New', monospace;
            line-height: 1.6;
            white-space: pre-wrap;
            color: #e0e0e0;
        }
        
        .document-content h1, .document-content h2, .document-content h3 {
            color: #7c3aed;
            margin: 20px 0 10px 0;
        }
        
        .document-content h1 { font-size: 28px; }
        .document-content h2 { font-size: 22px; }
        .document-content h3 { font-size: 18px; }
        
        .draft-mode {
            background: #1a1a2e;
            border: 2px dashed #7c3aed;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .draft-mode textarea {
            width: 100%;
            min-height: 400px;
            background: #0a0a0a;
            color: #e0e0e0;
            border: 1px solid #333;
            padding: 15px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
        }
        
        /* 1/4 Frank Chat Sidebar */
        .frank-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #111;
            min-width: 300px;
        }
        
        .frank-header {
            padding: 15px;
            background: #1a1a2e;
            border-bottom: 1px solid #333;
        }
        
        .frank-title {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .frank-subtitle {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        
        .frank-chat {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            max-width: 90%;
            word-wrap: break-word;
        }
        
        .message.frank {
            align-self: flex-start;
        }
        
        .message.user {
            align-self: flex-end;
        }
        
        .message-bubble {
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 14px;
        }
        
        .message.frank .message-bubble {
            background: rgba(124, 58, 237, 0.1);
            border: 1px solid #7c3aed;
            color: #e0e0e0;
        }
        
        .message.user .message-bubble {
            background: #7c3aed;
            color: white;
        }
        
        .frank-actions {
            padding: 10px;
            background: #1a1a2e;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            border-top: 1px solid #333;
            border-bottom: 1px solid #333;
        }
        
        .action-btn {
            padding: 6px 12px;
            background: rgba(124, 58, 237, 0.2);
            border: 1px solid #7c3aed;
            color: #fff;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .action-btn:hover {
            background: #7c3aed;
        }
        
        .frank-input-container {
            padding: 15px;
            background: #1a1a2e;
            display: flex;
            gap: 10px;
        }
        
        .frank-input {
            flex: 1;
            background: #0a0a0a;
            border: 1px solid #333;
            color: #e0e0e0;
            padding: 10px;
            border-radius: 20px;
            resize: none;
            font-family: inherit;
            font-size: 14px;
        }
        
        .send-btn {
            background: #7c3aed;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .send-btn:hover {
            background: #6b2ed3;
            transform: scale(1.05);
        }
        
        /* Workflow Status */
        .workflow-status {
            padding: 15px;
            background: #1a1a2e;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .workflow-step {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
        }
        
        .step-indicator {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .step-indicator.active {
            background: #7c3aed;
            color: white;
        }
        
        .step-indicator.completed {
            background: #10b981;
            color: white;
        }
        
        .step-label {
            flex: 1;
            font-size: 14px;
        }
        
        /* Loading State */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #333;
            border-top-color: #7c3aed;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Validation Results */
        .validation-panel {
            background: #1a1a2e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .validation-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
        }
        
        .validation-status {
            font-size: 18px;
        }
        
        .validation-status.pass { color: #10b981; }
        .validation-status.fail { color: #ef4444; }
        .validation-status.pending { color: #f59e0b; }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .document-panel {
                border-right: none;
                border-bottom: 1px solid #333;
            }
            
            .frank-panel {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìù Project Workspace</h1>
        <div class="status-bar">
            <div class="status-indicator" id="draftStatus">No Active Draft</div>
            <div class="status-indicator" id="frankStatus">Frank: Online</div>
        </div>
    </div>
    
    <div class="main-container">
        <!-- 3/4 Document Panel -->
        <div class="document-panel">
            <div class="doc-tabs">
                <button class="doc-tab active" onclick="switchTab('production')">Project.md (Production)</button>
                <button class="doc-tab" onclick="switchTab('draft')">Draft</button>
                <button class="doc-tab" onclick="switchTab('validation')">Validation</button>
                <button class="doc-tab" onclick="switchTab('tasks')">Tasks</button>
            </div>
            
            <div class="document-viewer" id="documentViewer">
                <div class="document-content" id="documentContent">
                    Loading Project.md...
                </div>
            </div>
        </div>
        
        <!-- 1/4 Frank Chat Panel -->
        <div class="frank-panel">
            <div class="frank-header">
                <div class="frank-title">
                    üéØ Frank
                </div>
                <div class="frank-subtitle">Doc-Driven Development Assistant</div>
            </div>
            
            <div class="frank-actions">
                <button class="action-btn" onclick="frankAction('create-draft')">üìù Create Draft</button>
                <button class="action-btn" onclick="frankAction('validate')">‚úÖ Validate</button>
                <button class="action-btn" onclick="frankAction('breakdown')">üìã Break to Tasks</button>
                <button class="action-btn" onclick="frankAction('status')">üìä Status</button>
                <button class="action-btn" onclick="frankAction('merge')">üîÄ Merge</button>
            </div>
            
            <div class="frank-chat" id="frankChat">
                <div class="message frank">
                    <div class="message-bubble">
                        Yo, I'm Frank. I manage the doc-driven development flow here.
                        <br><br>
                        We follow the immutable flow: Draft ‚Üí Validation ‚Üí Task ‚Üí Checkpoint ‚Üí Review ‚Üí Merge.
                        <br><br>
                        What changes you wanna make to Project.md? I'll create a draft and walk you through the process. No BS, just structured development.
                    </div>
                </div>
            </div>
            
            <div class="frank-input-container">
                <textarea class="frank-input" id="frankInput" placeholder="Tell Frank what to change..." rows="2"></textarea>
                <button class="send-btn" onclick="sendToFrank()">Send</button>
            </div>
        </div>
    </div>
    
    <script>
        let currentTab = 'production';
        let currentDraft = null;
        let validationResults = null;
        let tasks = [];
        
        // Load Project.md on startup
        async function loadProjectMd() {
            try {
                // Load from the docs to work towards folder
                const response = await fetch('/docs%20to%20work%20towards/project.md');
                const text = await response.text();
                
                if (currentTab === 'production') {
                    document.getElementById('documentContent').textContent = text;
                }
            } catch (error) {
                document.getElementById('documentContent').textContent = 'Failed to load Project.md: ' + error.message;
            }
        }
        
        // Switch tabs
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab styling
            document.querySelectorAll('.doc-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update content
            const content = document.getElementById('documentContent');
            
            switch(tab) {
                case 'production':
                    loadProjectMd();
                    break;
                    
                case 'draft':
                    if (currentDraft) {
                        content.innerHTML = `
                            <div class="draft-mode">
                                <h2>üìù Active Draft</h2>
                                <p>ID: ${currentDraft.id}</p>
                                <p>Status: ${currentDraft.state}</p>
                                <p>Created: ${currentDraft.created}</p>
                                <textarea id="draftEditor">${currentDraft.content || ''}</textarea>
                                <br><br>
                                <button class="action-btn" onclick="saveDraft()">üíæ Save Draft</button>
                                <button class="action-btn" onclick="validateDraft()">‚úÖ Validate</button>
                            </div>
                        `;
                    } else {
                        content.innerHTML = `
                            <div class="draft-mode">
                                <h2>No Active Draft</h2>
                                <p>Ask Frank to create a draft from your changes.</p>
                            </div>
                        `;
                    }
                    break;
                    
                case 'validation':
                    if (validationResults) {
                        content.innerHTML = `
                            <div class="validation-panel">
                                <h2>Validation Results</h2>
                                ${renderValidationResults()}
                            </div>
                        `;
                    } else {
                        content.textContent = 'No validation results yet. Create and validate a draft first.';
                    }
                    break;
                    
                case 'tasks':
                    if (tasks.length > 0) {
                        content.innerHTML = `
                            <div class="workflow-status">
                                <h2>Generated Tasks</h2>
                                ${tasks.map(task => `
                                    <div class="workflow-step">
                                        <span class="step-indicator">${task.priority === 'high' ? 'üî¥' : 'üü°'}</span>
                                        <span class="step-label">
                                            <strong>${task.name}</strong><br>
                                            ${task.objective}<br>
                                            <small>GitHub Issue: #${task.githubIssueNumber || 'pending'}</small>
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        content.textContent = 'No tasks generated yet. Validate your draft first.';
                    }
                    break;
            }
        }
        
        // Frank actions
        async function frankAction(action) {
            const chat = document.getElementById('frankChat');
            
            switch(action) {
                case 'create-draft':
                    addFrankMessage("Alright, I'm creating a draft. What changes you want to make? Be specific.");
                    break;
                    
                case 'validate':
                    if (!currentDraft) {
                        addFrankMessage("No draft to validate. Create one first, genius.");
                        return;
                    }
                    addFrankMessage("Validating draft against Interface.md and Technical.md...");
                    await validateDraft();
                    break;
                    
                case 'breakdown':
                    if (!validationResults?.overall_passed) {
                        addFrankMessage("Draft needs to pass validation first. Fix the issues.");
                        return;
                    }
                    addFrankMessage("Breaking down changes into tasks...");
                    await breakdownToTasks();
                    break;
                    
                case 'status':
                    showWorkflowStatus();
                    break;
                    
                case 'merge':
                    if (currentDraft?.state !== 'ready_for_merge') {
                        addFrankMessage("Can't merge yet. Complete all tasks and get human approval first.");
                        return;
                    }
                    await mergeDraft();
                    break;
            }
        }
        
        // Send message to Frank
        async function sendToFrank() {
            const input = document.getElementById('frankInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addUserMessage(message);
            input.value = '';
            
            // Build context
            const context = {
                draftId: currentDraft?.id,
                draftState: currentDraft?.state,
                tasks: tasks,
                validations: validationResults
            };
            
            // Send to Frank API
            addFrankMessage("Let me think about that...");
            
            try {
                const response = await fetch('/api/frank-assistant', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        context: context
                    })
                });
                
                const result = await response.json();
                
                // Remove "thinking" message
                const chat = document.getElementById('frankChat');
                chat.removeChild(chat.lastChild);
                
                // Add Frank's response
                addFrankMessage(result.response);
                
                // Handle specific actions
                if (result.action === 'draft_created' && result.draftId) {
                    currentDraft = {
                        id: result.draftId,
                        state: 'created',
                        created: new Date().toISOString(),
                        content: document.getElementById('documentContent').textContent,
                        githubIssueNumber: result.githubIssue
                    };
                    document.getElementById('draftStatus').textContent = `Draft: ${result.draftId}`;
                } else if (result.action === 'validation_passed' || result.action === 'validation_failed') {
                    validationResults = result.validations;
                    if (result.success) {
                        currentDraft.state = 'validated';
                    }
                } else if (result.action === 'tasks_created') {
                    tasks = result.tasks;
                    currentDraft.state = 'task_breakdown';
                } else if (result.action === 'task_executing') {
                    // Update task status
                    const taskIndex = tasks.findIndex(t => t.status === 'pending');
                    if (taskIndex >= 0) {
                        tasks[taskIndex].status = 'executing';
                        tasks[taskIndex].threadId = result.threadId;
                    }
                } else if (result.action === 'merged') {
                    currentDraft = null;
                    validationResults = null;
                    tasks = [];
                    document.getElementById('draftStatus').textContent = 'No Active Draft';
                    loadProjectMd();
                }
                
                // Auto-switch tabs for certain actions
                if (result.action === 'validation_passed' || result.action === 'validation_failed') {
                    switchTabByName('validation');
                } else if (result.action === 'tasks_created') {
                    switchTabByName('tasks');
                }
                
            } catch (error) {
                // Remove "thinking" message
                const chat = document.getElementById('frankChat');
                chat.removeChild(chat.lastChild);
                
                addFrankMessage(`Error talking to the server: ${error.message}. Check if the API is running.`);
            }
        }
        
        // Helper to switch tabs programmatically
        function switchTabByName(tabName) {
            const tabButtons = document.querySelectorAll('.doc-tab');
            for (const button of tabButtons) {
                if (button.textContent.toLowerCase().includes(tabName.toLowerCase())) {
                    button.click();
                    break;
                }
            }
        }
        
        // Create draft
        async function createDraft(description) {
            addFrankMessage("Creating draft...");
            
            try {
                const response = await fetch('/api/project-draft-manager?action=create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: document.getElementById('documentContent').textContent,
                        description: description,
                        author: 'frank-ui'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentDraft = {
                        id: result.draftId,
                        state: result.state,
                        created: new Date().toISOString(),
                        content: document.getElementById('documentContent').textContent
                    };
                    
                    document.getElementById('draftStatus').textContent = `Draft: ${result.draftId}`;
                    addFrankMessage(`Draft created: ${result.draftId}. Switch to the Draft tab to edit it. Then we'll validate.`);
                } else {
                    addFrankMessage(`Failed to create draft: ${result.error}`);
                }
            } catch (error) {
                addFrankMessage(`Error creating draft: ${error.message}`);
            }
        }
        
        // Validate draft
        async function validateDraft() {
            if (!currentDraft) {
                addFrankMessage("No draft to validate. Create one first.");
                return;
            }
            
            addFrankMessage("Running validation checks...");
            
            try {
                const response = await fetch('/api/project-draft-manager?action=validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        draftId: currentDraft.id
                    })
                });
                
                const result = await response.json();
                
                validationResults = result.validations;
                currentDraft.state = result.state;
                
                if (result.allPassed) {
                    addFrankMessage("‚úÖ Validation passed! Ready to break down into tasks.");
                } else {
                    addFrankMessage("‚ùå Validation failed. Check the Validation tab for issues.");
                }
                
                switchTab('validation');
            } catch (error) {
                addFrankMessage(`Validation error: ${error.message}`);
            }
        }
        
        // Break down to tasks
        async function breakdownToTasks() {
            if (!currentDraft || currentDraft.state !== 'validated') {
                addFrankMessage("Draft must be validated first.");
                return;
            }
            
            addFrankMessage("Breaking down into tasks...");
            
            try {
                const response = await fetch('/api/project-draft-manager?action=breakdown', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        draftId: currentDraft.id
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    tasks = result.tasks;
                    currentDraft.state = result.state;
                    addFrankMessage(`Created ${result.tasks.length} tasks. Check the Tasks tab. Each one's tracked in GitHub.`);
                    switchTab('tasks');
                } else {
                    addFrankMessage(`Failed to create tasks: ${result.error}`);
                }
            } catch (error) {
                addFrankMessage(`Task breakdown error: ${error.message}`);
            }
        }
        
        // Show workflow status
        function showWorkflowStatus() {
            const status = `
Current Workflow Status:
${currentDraft ? `‚úì Draft: ${currentDraft.id} (${currentDraft.state})` : '‚óã No active draft'}
${validationResults ? '‚úì Validation: ' + (validationResults.every(v => v.passed) ? 'Passed' : 'Failed') : '‚óã Not validated'}
${tasks.length > 0 ? `‚úì Tasks: ${tasks.length} created` : '‚óã No tasks'}
‚óã Checkpoints: Not implemented yet
‚óã Review: Pending
‚óã Merge: Not ready
            `;
            addFrankMessage(status);
        }
        
        // Render validation results
        function renderValidationResults() {
            if (!validationResults) return '';
            
            return validationResults.map(v => `
                <div class="validation-item">
                    <span class="validation-status ${v.passed ? 'pass' : 'fail'}">
                        ${v.passed ? '‚úÖ' : '‚ùå'}
                    </span>
                    <span>
                        <strong>${v.type}</strong><br>
                        ${v.message}
                    </span>
                </div>
            `).join('');
        }
        
        // Add Frank message
        function addFrankMessage(text) {
            const chat = document.getElementById('frankChat');
            const message = document.createElement('div');
            message.className = 'message frank';
            message.innerHTML = `<div class="message-bubble">${text}</div>`;
            chat.appendChild(message);
            chat.scrollTop = chat.scrollHeight;
        }
        
        // Add user message
        function addUserMessage(text) {
            const chat = document.getElementById('frankChat');
            const message = document.createElement('div');
            message.className = 'message user';
            message.innerHTML = `<div class="message-bubble">${text}</div>`;
            chat.appendChild(message);
            chat.scrollTop = chat.scrollHeight;
        }
        
        // Save draft
        async function saveDraft() {
            const content = document.getElementById('draftEditor').value;
            currentDraft.content = content;
            addFrankMessage("Draft saved locally. Now validate it to proceed.");
        }
        
        // Merge draft
        async function mergeDraft() {
            addFrankMessage("Merging draft to production Project.md...");
            
            try {
                const response = await fetch('/api/project-draft-manager?action=merge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        draftId: currentDraft.id
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addFrankMessage("‚úÖ Draft merged to production! Project.md updated.");
                    currentDraft = null;
                    validationResults = null;
                    tasks = [];
                    document.getElementById('draftStatus').textContent = 'No Active Draft';
                    loadProjectMd();
                } else {
                    addFrankMessage(`Merge failed: ${result.error}`);
                }
            } catch (error) {
                addFrankMessage(`Merge error: ${error.message}`);
            }
        }
        
        // Enter key to send
        document.getElementById('frankInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendToFrank();
            }
        });
        
        // Load on startup
        loadProjectMd();
    </script>
</body>
</html>